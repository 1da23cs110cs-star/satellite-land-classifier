<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Satellite Land Classifier — Dual Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<style>
:root{
  --header-start:#2fc0ff;
  --header-end:#00a3ff;
  --panel-bg:#ffffff;
  --panel-ink:#042a3f;
  --muted:#6b8896;
  --btn-start:#00b0ff;
  --btn-end:#0077ff;
  --btn-shadow: 0 14px 36px rgba(0,119,255,0.14);
}

/* header */
.header {
  display:flex;align-items:center;gap:12px;padding:14px 18px;background:linear-gradient(90deg,var(--header-start),var(--header-end));
  color:white; box-shadow:0 8px 20px rgba(0,0,0,0.08);
}
.header .icon { width:56px;height:56px;border-radius:12px;background:white;display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 18px rgba(0,0,0,0.12); animation: pulse 2.6s ease-in-out infinite;
}
@keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.035)}100%{transform:scale(1)} }
.header .title { font-weight:800; font-size:18px; }
.header .subtitle { font-size:13px; color: rgba(255,255,255,0.95) }

/* layout */
.container { display:flex; gap:16px; height: calc(100vh - 84px); padding:18px; background: linear-gradient(180deg,#f7fbff,#eef8ff); }
.left { width:360px; display:flex; align-items:center; justify-content:center; }
.card { width:320px; background:var(--panel-bg); padding:20px; border-radius:14px; box-shadow:0 12px 36px rgba(10,40,80,0.06); text-align:center; }
.card h3 { margin:0 0 8px 0; color:var(--panel-ink); }
.card p { margin:0 0 14px 0; color:var(--muted) }

/* Buttons */
.btn { display:inline-block;padding:10px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:800;color:white;
  background:linear-gradient(180deg,var(--btn-start),var(--btn-end)); box-shadow:var(--btn-shadow); transition:transform .12s ease, box-shadow .12s ease; }
.btn:hover{ transform: translateY(-3px); }
.btn.ghost{ background:#ffffff;color:var(--btn-end); box-shadow:none; border:1px solid rgba(0,119,255,0.12); font-weight:700; }
.select { padding:8px 10px; border-radius:8px; border:1px solid #e6eef8; background:white; color:var(--panel-ink) }
.status { margin-top:8px; color:var(--muted) }

/* map area (right) */
.mapwrap { flex:1; border-radius:14px; overflow:hidden; box-shadow:0 12px 36px rgba(0,0,0,0.06); position:relative; background:white; display:flex; flex-direction:column; }

/* Two halves of map */
.map-half { flex:1; position:relative; min-height:120px; border-bottom:none; }
.map-half.top { border-bottom: 1px solid rgba(2,18,30,0.08); } /* <-- thin border line between maps */
.map-half.bottom { border-bottom: none; }

.map-half #mapTop { width:100%; height:100%; display:block; }
.map-half #mapBottom { width:100%; height:100%; display:block; }

/* top floating label */
.map-top-text {
  position:absolute; top:12px; left:50%; transform:translateX(-50%); z-index:900;
  background:white; padding:10px 14px; border-radius:12px; font-weight:700; color:var(--btn-end);
  box-shadow:0 12px 36px rgba(0,119,255,0.08); border:1px solid rgba(0,119,255,0.08);
}

/* small responsive */
@media (max-width:900px){
  .container{flex-direction:column;padding:12px;height:auto}
  .left{order:2}
  .mapwrap{order:1;height:auto}
  .map-half{height:45vh}
}
</style>
</head>
<body>

<header class="header">
  <div class="icon" aria-hidden="true">
    <svg viewBox="0 0 64 64" width="36" height="36" xmlns="http://www.w3.org/2000/svg" role="img" focusable="false">
      <rect x="12" y="12" width="40" height="28" rx="4" ry="4" fill="#ffffff" stroke="#00a3ff" stroke-width="2"/>
      <rect x="30" y="6" width="4" height="8" rx="1" ry="1" fill="#00a3ff"/>
      <rect x="2" y="22" width="10" height="18" rx="2" ry="2" fill="#0077ff"/>
      <g fill="#cfeeff"><rect x="4" y="24" width="2" height="14"/><rect x="7" y="24" width="2" height="14"/></g>
      <rect x="52" y="22" width="10" height="18" rx="2" ry="2" fill="#0077ff"/>
      <g fill="#cfeeff"><rect x="54" y="24" width="2" height="14"/><rect x="57" y="24" width="2" height="14"/></g>
      <circle cx="32" cy="26" r="6" fill="#00a3ff"/>
      <circle cx="32" cy="26" r="3.2" fill="#ffffff"/>
    </svg>
  </div>

  <div>
    <div class="title">Satellite Land Classifier</div>
    <div class="subtitle">ESA WorldCover — instant land-cover classification (water, vegetation, urban, and more)</div>
  </div>
</header>

<div class="container">
  <div class="left">
    <div class="card">
      <h3>Tools</h3>
      <p>Use the top map for navigation & draw. Bottom shows the colored WorldCover (that will be uploaded).</p>

      <div style="display:flex;justify-content:center;gap:8px;margin-bottom:10px">
        <button id="drawBtn" class="btn ghost">Draw</button>
        <button id="bigBoxBtn" class="btn">Create Big Box</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
      </div>

      <div style="margin:10px 0">
        <div style="color:var(--muted);font-size:13px;margin-bottom:6px">Fetch resolution (max dimension)</div>
        <select id="sizeSelect" class="select">
          <option value="512">512</option>
          <option value="800" selected>800</option>
          <option value="1024">1024</option>
        </select>
      </div>

      <div style="margin-top:12px">
        <button id="classifyBtn" class="btn" style="width:100%;">Classify (open result)</button>
      </div>

      <div class="status" id="status">Status: Ready</div>
    </div>
  </div>

  <div class="mapwrap">
    <div class="map-top-text" id="mapTopText">Draw the region to classify (top map)</div>

    <!-- Top half: realtime map (OSM-like) -->
    <div class="map-half top">
      <div id="mapTop"></div>
    </div>

    <!-- Bottom half: colored WMS map (WorldCover) -->
    <div class="map-half bottom">
      <div id="mapBottom"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://rawcdn.githack.com/mapbox/leaflet-image/gh-pages/leaflet-image.js"></script>

<script>
/* ----------------- Two maps initialization ----------------- */
const mapTop = L.map('mapTop', {preferCanvas:true}).setView([20,78], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap contributors', crossOrigin: true
}).addTo(mapTop);

const mapBottom = L.map('mapBottom', {preferCanvas:true, zoomControl:false}).setView(mapTop.getCenter(), mapTop.getZoom());
const wmsLayer = L.tileLayer.wms('https://services.terrascope.be/wms/v2', {
  layers: 'WORLDCOVER_2021_MAP',
  format: 'image/png',
  transparent: false,
  attribution: 'ESA WorldCover 2021',
  maxZoom: 12,
  crossOrigin: true
}).addTo(mapBottom);

setTimeout(()=>{ mapTop.invalidateSize(); mapBottom.invalidateSize(); }, 200);

/* ----------------- Sync both maps ----------------- */
let syncing = false;
function syncFromTop(){ if(syncing)return; syncing=true; mapBottom.setView(mapTop.getCenter(),mapTop.getZoom(),{animate:false}); syncing=false;}
function syncFromBottom(){ if(syncing)return; syncing=true; mapTop.setView(mapBottom.getCenter(),mapBottom.getZoom(),{animate:false}); syncing=false;}
mapTop.on('moveend zoomend',syncFromTop);
mapBottom.on('moveend zoomend',syncFromBottom);

/* ----------------- Drawing (Top map only, mirrored to bottom) ----------------- */
let drawnTop = new L.FeatureGroup().addTo(mapTop);
let drawnBottom = new L.FeatureGroup().addTo(mapBottom);
const drawControlTop = new L.Control.Draw({
  draw:{ rectangle:{ shapeOptions:{color:'#0a84ff', weight:2, dashArray:'6 6'} }, polygon:false, polyline:false, circle:false, marker:false},
  edit:{ featureGroup: drawnTop, remove:true }
});
mapTop.addControl(drawControlTop);

let lastRect=null,lastRectBottom=null;
mapTop.on(L.Draw.Event.CREATED,e=>{
  drawnTop.clearLayers(); drawnBottom.clearLayers();
  drawnTop.addLayer(e.layer); lastRect=e.layer;
  const b=e.layer.getBounds();
  const mirror=L.rectangle(b,{color:'#0a84ff',weight:2,dashArray:'6 6'}).addTo(drawnBottom);
  lastRectBottom=mirror;
  document.getElementById('status').innerText='Status: Crop ready';
});
mapTop.on(L.Draw.Event.EDITED,()=>{
  const topLayer=drawnTop.getLayers()[0]||null;
  if(topLayer){lastRect=topLayer; const b=topLayer.getBounds();
    if(lastRectBottom){lastRectBottom.setBounds(b);} else {
      lastRectBottom=L.rectangle(b,{color:'#0a84ff',weight:2,dashArray:'6 6'}).addTo(drawnBottom);
    }}
});
mapTop.on(L.Draw.Event.DELETED,()=>{
  drawnTop.clearLayers(); drawnBottom.clearLayers(); lastRect=null; lastRectBottom=null;
  document.getElementById('status').innerText='Status: Ready';
});

/* ----------------- Buttons ----------------- */
document.getElementById('drawBtn').onclick=()=>{const d=new L.Draw.Rectangle(mapTop,drawControlTop.options.draw.rectangle);d.enable();document.getElementById('status').innerText='Status: Drawing...';};
document.getElementById('bigBoxBtn').onclick=()=>{
  const b=mapTop.getBounds(),s=b.getSouth(),n=b.getNorth(),w=b.getWest(),e=b.getEast();
  const latSpan=n-s,lonSpan=e-w,pad=0.15,ns=s+latSpan*pad,nn=n-latSpan*pad,nw=w+lonSpan*pad,ne=e-lonSpan*pad;
  drawnTop.clearLayers(); drawnBottom.clearLayers();
  const rectTop=L.rectangle([[ns,nw],[nn,ne]],{color:'#0a84ff',weight:2,dashArray:'6 6'}).addTo(drawnTop);
  const rectBottom=L.rectangle([[ns,nw],[nn,ne]],{color:'#0a84ff',weight:2,dashArray:'6 6'}).addTo(drawnBottom);
  lastRect=rectTop; lastRectBottom=rectBottom;
  mapTop.fitBounds(rectTop.getBounds()); mapBottom.fitBounds(rectBottom.getBounds());
  document.getElementById('status').innerText='Status: Big crop created';
};
document.getElementById('clearBtn').onclick=()=>{drawnTop.clearLayers(); drawnBottom.clearLayers(); lastRect=null; lastRectBottom=null; document.getElementById('status').innerText='Status: Cleared';};

/* ----------------- Helpers ----------------- */
function hideDrawnLayersFromLayerGroup(group){const saved=[];group.eachLayer(l=>{saved.push(l);if(l.setStyle)l.setStyle({stroke:false,fill:false,opacity:0,fillOpacity:0});});return saved;}
function restoreDrawnLayersToLayerGroup(group){group.eachLayer(l=>{if(l.setStyle)l.setStyle({stroke:true,fill:false,opacity:1,fillOpacity:1});});}
function makeCompressedDataURL(canvas,targetSize){const maxDim=Math.max(canvas.width,canvas.height);let out=canvas;if(maxDim>targetSize){const scale=targetSize/maxDim;const r=document.createElement('canvas');r.width=Math.round(canvas.width*scale);r.height=Math.round(canvas.height*scale);r.getContext('2d').drawImage(canvas,0,0,r.width,r.height);out=r;}return out.toDataURL('image/jpeg',0.8);}
function dataURLtoBlob(dataurl){const arr=dataurl.split(','),mime=arr[0].match(/:(.*?);/)[1];const bstr=atob(arr[1]);let n=bstr.length;const u8=new Uint8Array(n);while(n--){u8[n]=bstr.charCodeAt(n);}return new Blob([u8],{type:mime});}

/* ----------------- Capture Bottom Map ----------------- */
document.getElementById('classifyBtn').onclick=()=>{
  if(!lastRectBottom){alert('Draw a rectangle first on the top map.');return;}
  const topText=document.getElementById('mapTopText');
  topText.innerText='Please wait — result is processing…';
  document.getElementById('status').innerText='Status: Rendering image...';

  const saved=hideDrawnLayersFromLayerGroup(drawnBottom);
  leafletImage(mapBottom,(err,canvas)=>{
    restoreDrawnLayersToLayerGroup(drawnBottom);
    if(err){alert('Error rendering bottom map: '+err);document.getElementById('status').innerText='Status: Ready';topText.innerText='Draw the region to classify (top map)';return;}
    const b=lastRectBottom.getBounds(),south=b.getSouth(),west=b.getWest(),north=b.getNorth(),east=b.getEast();
    const sw=mapBottom.latLngToContainerPoint([south,west]),ne=mapBottom.latLngToContainerPoint([north,east]);
    const x=Math.round(Math.min(sw.x,ne.x)),y=Math.round(Math.min(ne.y,sw.y)),w=Math.round(Math.abs(ne.x-sw.x)),h=Math.round(Math.abs(ne.y-sw.y));
    if(w<=0||h<=0){alert('Invalid crop size. Try drawing again.');document.getElementById('status').innerText='Status: Ready';topText.innerText='Draw the region to classify (top map)';return;}
    const out=document.createElement('canvas');out.width=w;out.height=h;const ctx=out.getContext('2d');ctx.drawImage(canvas,x,y,w,h,0,0,w,h);
    const size=parseInt(document.getElementById('sizeSelect').value,10)||800;
    const dataURL=makeCompressedDataURL(out,size);const blob=dataURLtoBlob(dataURL);
    const fd=new FormData();fd.append('imagefile',blob,'crop.jpg');fd.append('west',west);fd.append('south',south);fd.append('east',east);fd.append('north',north);fd.append('size',size);
    document.getElementById('status').innerText='Status: Uploading...';
    fetch('/upload_blob',{method:'POST',body:fd}).then(r=>{if(!r.ok)throw new Error('Server '+r.status);return r.text();}).then(html=>{const w=window.open();w.document.open();w.document.write(html);w.document.close();document.getElementById('status').innerText='Status: Done — result opened';topText.innerText='Draw the region to classify (top map)';}).catch(err=>{alert('Upload failed: '+err.message);document.getElementById('status').innerText='Status: Ready';topText.innerText='Draw the region to classify (top map)';});
  });
};
</script>
</body>
</html>
